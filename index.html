<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>설문조사 집계 및 통계 도구</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            display: flex;
            width: 95%;
            max-width: 1400px;
            gap: 20px;
            margin-bottom: 20px;
        }
        .section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-section {
            flex: 1;
            min-width: 350px;
            /* 입력창 고정 */
            position: sticky;
            top: 20px;
            align-self: flex-start;
        }
        .statistics-section {
            flex: 2;
            min-width: 400px;
        }
        .data-list-section {
            width: 95%;
            max-width: 1400px;
        }
        h1, h2 {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, button {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 16px;
        }
        .full-width {
             width: 100%;
             margin-top: 5px;
        }
        .submit-btn {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 20px;
        }
        .submit-btn:hover {
            background-color: #0056b3;
        }
        .radio-group {
            display: flex;
            gap: 15px;
            padding-top: 5px;
        }
        .radio-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        #data-list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        /* 새로 입력된 항목 강조 효과 */
        .highlight {
            background-color: #ffffe0 !important;
            transition: background-color 0.5s ease;
        }
        #progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        #progress-bar {
            width: 0%;
            height: 25px;
            background-color: #28a745;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
            white-space: nowrap;
        }
        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .export-btn {
            background-color: #17a2b8;
            color: white;
        }
        .export-btn:hover {
            background-color: #138496;
        }
        .clear-btn {
            background-color: #6c757d;
            color: white;
        }
        .clear-btn:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

    <h1>설문조사 집계 및 통계 도구 (목표: 806장)</h1>

    <div class="container">
        <div class="section input-section">
            <h2>1. 설문지 데이터 입력</h2>
            <form id="survey-form">
                <div class="form-group">
                    <label for="age">Q1. 나이대</label>
                    <select id="age" class="full-width" required>
                        <option value="">선택하세요</option>
                        <option value="10대">10대</option>
                        <option value="20대">20대</option>
                        <option value="30대">30대</option>
                        <option value="40대">40대</option>
                        <option value="50대">50대</option>
                        <option value="60대 이상">60대 이상</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Q2. PVT가 탄소배출 및 에너지비용 절감에 효과가 있다고 생각하십니까?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="q2" value="그렇다" required> 그렇다</label>
                        <label><input type="radio" name="q2" value="아니다"> 아니다</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Q3. PVT제품이 일반 태양광 대비 경제성과 효율성 면에서 경쟁력이 있다고 생각하시나요?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="q3" value="그렇다" required> 그렇다</label>
                        <label><input type="radio" name="q3" value="아니다"> 아니다</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Q4. 귀하의 건물 또는 사업장에 PVT를 도입할 의향이 있으십니까?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="q4" value="그렇다" required> 그렇다</label>
                        <label><input type="radio" name="q4" value="아니다"> 아니다</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Q5. 펌프스테이션과 같이 부품 통일화 제품이 유지관리 및 안정성에 도움이 된다고 생각하시나요?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="q5" value="그렇다" required> 그렇다</label>
                        <label><input type="radio" name="q5" value="아니다"> 아니다</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Q6. 펌프스테이션 도입 시기가 빠를수록 좋다고 생각하시나요?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="q6" value="그렇다" required> 그렇다</label>
                        <label><input type="radio" name="q6" value="아니다"> 아니다</label>
                    </div>
                </div>

                <button type="submit" class="full-width submit-btn">데이터 저장 및 다음 설문 입력</button>
            </form>
        </div>

        <div class="section statistics-section">
            <h2>2. 실시간 통계 현황</h2>
            <div id="progress-bar-container">
                <div id="progress-bar">0%</div>
            </div>
            <p>총 입력된 설문지 수: <strong id="total-count">0</strong>장</p>

            <h3>Q1. 나이대 분포</h3>
            <table id="stats-age">
                <thead>
                    <tr>
                        <th>나이대</th>
                        <th>응답 수</th>
                        <th>비율 (%)</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <h3>Q2 ~ Q6. 항목별 응답 결과</h3>
            <table id="stats-questions">
                <thead>
                    <tr>
                        <th>질문 항목</th>
                        <th>그렇다 (수)</th>
                        <th>그렇다 (%)</th>
                        <th>아니다 (수)</th>
                        <th>아니다 (%)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Q2. 탄소배출 및 에너지비용 절감 효과</td><td id="q2-yes-count">0</td><td id="q2-yes-perc">0%</td><td id="q2-no-count">0</td><td id="q2-no-perc">0%</td></tr>
                    <tr><td>Q3. 경제성 및 효율성 경쟁력</td><td id="q3-yes-count">0</td><td id="q3-yes-perc">0%</td><td id="q3-no-count">0</td><td id="q3-no-perc">0%</td></tr>
                    <tr><td>Q4. PVT 도입 의향</td><td id="q4-yes-count">0</td><td id="q4-yes-perc">0%</td><td id="q4-no-count">0</td><td id="q4-no-perc">0%</td></tr>
                    <tr><td>Q5. 펌프스테이션 유지관리 및 안정성 도움</td><td id="q5-yes-count">0</td><td id="q5-yes-perc">0%</td><td id="q5-no-count">0</td><td id="q5-no-perc">0%</td></tr>
                    <tr><td>Q6. 펌프스테이션 조기 도입 필요성</td><td id="q6-yes-count">0</td><td id="q6-yes-perc">0%</td><td id="q6-no-count">0</td><td id="q6-no-perc">0%</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="section data-list-section">
        <h2>3. 입력된 데이터 목록 (검토 및 관리)</h2>
        <div id="data-list-container">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>순번</th>
                        <th>Q1. 나이대</th>
                        <th>Q2</th>
                        <th>Q3</th>
                        <th>Q4</th>
                        <th>Q5</th>
                        <th>Q6</th>
                        <th>삭제</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="controls">
            <button id="export-csv-btn" class="export-btn">CSV 파일로 내보내기 (백업)</button>
            <button id="clear-all-btn" class="clear-btn">모든 데이터 초기화</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('survey-form');
            const dataTableBody = document.querySelector('#data-table tbody');
            const dataListContainer = document.getElementById('data-list-container');
            const TARGET_COUNT = 806;
            const STORAGE_KEY = 'surveyAggregatorData';

            // 1. 데이터 로드 (로컬 스토리지 사용)
            let surveyData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

            // 초기 렌더링
            updateView();

            // 2. 데이터 입력 처리
            form.addEventListener('submit', (e) => {
                e.preventDefault();

                const newData = {
                    id: Date.now(), // 고유 ID
                    age: document.getElementById('age').value,
                    q2: document.querySelector('input[name="q2"]:checked').value,
                    q3: document.querySelector('input[name="q3"]:checked').value,
                    q4: document.querySelector('input[name="q4"]:checked').value,
                    q5: document.querySelector('input[name="q5"]:checked').value,
                    q6: document.querySelector('input[name="q6"]:checked').value,
                };

                surveyData.push(newData);
                saveData();
                updateView(true); // 통계 및 목록 업데이트 (마지막 항목 강조 및 스크롤 이동)

                form.reset();
                document.getElementById('age').focus(); // 다음 입력을 위해 첫 항목으로 포커스 이동
            });

            // 3. 데이터 저장
            function saveData() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(surveyData));
            }

            // 4. 화면 업데이트 통합 함수
            function updateView(highlightLast = false) {
                renderDataList(highlightLast);
                updateStatistics();
            }

            // 5. 데이터 목록 렌더링
            function renderDataList(highlightLast) {
                dataTableBody.innerHTML = '';
                surveyData.forEach((data, index) => {
                    const row = document.createElement('tr');
                    
                    // 홀짝수 행 배경색 (Zebra striping)
                    if (index % 2 === 1) {
                        row.style.backgroundColor = '#f9f9f9';
                    }
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${data.age}</td>
                        <td>${data.q2}</td>
                        <td>${data.q3}</td>
                        <td>${data.q4}</td>
                        <td>${data.q5}</td>
                        <td>${data.q6}</td>
                        <td><button class="delete-btn" data-id="${data.id}">삭제</button></td>
                    `;
                    dataTableBody.appendChild(row);

                    // 마지막으로 추가된 항목 강조 표시
                    if (highlightLast && index === surveyData.length - 1) {
                        row.classList.add('highlight');
                        // 2초 후 강조 효과 제거
                        setTimeout(() => row.classList.remove('highlight'), 2000);
                    }
                });

                // 새로 추가된 항목으로 스크롤 이동
                if (highlightLast) {
                    dataListContainer.scrollTop = dataListContainer.scrollHeight;
                }
            }

            // 6. 데이터 삭제 (이벤트 위임 사용)
            dataTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const id = parseInt(e.target.getAttribute('data-id'));
                    if (confirm('이 데이터를 삭제하시겠습니까?')) {
                        surveyData = surveyData.filter(data => data.id !== id);
                        saveData();
                        updateView();
                    }
                }
            });

            // 7. 통계 업데이트
            function updateStatistics() {
                const totalCount = surveyData.length;
                document.getElementById('total-count').textContent = totalCount;

                // 진행률 업데이트
                const progress = Math.min((totalCount / TARGET_COUNT) * 100, 100);
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = `${progress.toFixed(1)}%`;
                progressBar.textContent = `${progress.toFixed(1)}% (${totalCount}/${TARGET_COUNT})`;

                // Q1. 나이대 통계
                const ageGroups = ['10대', '20대', '30대', '40대', '50대', '60대 이상'];
                const ageStats = ageGroups.reduce((acc, group) => ({ ...acc, [group]: 0 }), {});

                // Q2 ~ Q6 통계 초기화
                const questionStats = {};
                for (let i = 2; i <= 6; i++) {
                    questionStats[`q${i}`] = { yes: 0, no: 0 };
                }

                // 데이터 집계
                surveyData.forEach(data => {
                    if (ageStats.hasOwnProperty(data.age)) {
                        ageStats[data.age]++;
                    }

                    for (let i = 2; i <= 6; i++) {
                        const key = `q${i}`;
                        if (data[key] === '그렇다') {
                            questionStats[key].yes++;
                        } else if (data[key] === '아니다') {
                            questionStats[key].no++;
                        }
                    }
                });

                // 나이대 통계 렌더링
                const ageTableBody = document.querySelector('#stats-age tbody');
                ageTableBody.innerHTML = '';
                ageGroups.forEach(group => {
                    const count = ageStats[group];
                    // 0으로 나누는 경우 방지
                    const percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(1) : 0;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${group}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                    `;
                    ageTableBody.appendChild(row);
                });

                // Q2 ~ Q6 통계 렌더링
                for (let i = 2; i <= 6; i++) {
                    const key = `q${i}`;
                    const stats = questionStats[key];
                    const yesPerc = totalCount > 0 ? ((stats.yes / totalCount) * 100).toFixed(1) : 0;
                    const noPerc = totalCount > 0 ? ((stats.no / totalCount) * 100).toFixed(1) : 0;

                    document.getElementById(`${key}-yes-count`).textContent = stats.yes;
                    document.getElementById(`${key}-yes-perc`).textContent = `${yesPerc}%`;
                    document.getElementById(`${key}-no-count`).textContent = stats.no;
                    document.getElementById(`${key}-no-perc`).textContent = `${noPerc}%`;
                }
            }

            // 8. CSV 내보내기
            document.getElementById('export-csv-btn').addEventListener('click', () => {
                if (surveyData.length === 0) {
                    alert("내보낼 데이터가 없습니다.");
                    return;
                }

                // UTF-8 BOM 추가 (엑셀에서 한글 깨짐 방지)
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += "순번,Q1. 나이대,Q2. PVT 효과,Q3. PVT 경쟁력,Q4. PVT 도입 의향,Q5. 펌프스테이션 도움,Q6. 펌프스테이션 시기\r\n";

                surveyData.forEach((data, index) => {
                    const row = `${index + 1},${data.age},${data.q2},${data.q3},${data.q4},${data.q5},${data.q6}`;
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "survey_data_backup.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // 9. 모든 데이터 초기화
            document.getElementById('clear-all-btn').addEventListener('click', () => {
                if (confirm('정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다. 데이터를 CSV로 백업했는지 확인하세요.')) {
                    surveyData = [];
                    saveData();
                    updateView();
                    alert('모든 데이터가 초기화되었습니다.');
                }
            });
        });
    </script>
</body>
</html>